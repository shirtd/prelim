% !TeX root = ../new.tex

% \clearpage

In the following let $D\subi{w,a} := B_w\cup f\rest_{\comp{B_w}}^{-1}(-\infty,a]$ and $P\subi{w,a} := P\cap D\subi{w,a}$.

\begin{lemma}\label{lem:extension_apply}
  If $Q_w^\e$ surrounds $P^\e$ in $D$ then for all $w,a\in\R$ and $\ext{P\subi{w,a}^\e} = P\subi{w,a}^\e \cup (D\setminus P^\e)$
  \[\hom_k(P\subi{w,a}^\e, Q_w^\e)\cong \hom_k(\ext{P\subi{w,a}^\e}, \ext{Q^\e_a}).\]
\end{lemma}
\begin{proof}
  Because $P\subi{w,a} := P\cap D\subi{w,a}$ and $B_w\subseteq D\subi{w,a}$ we know $Q_w = P\cap B_w \subseteq P\subi{w,a}$ for all $w,a\in\R$.
  So
  \[\ext{Q^\e_a} = Q^\e_a\cup (D\setminus P^\e) \subseteq P\subi{w,a}^\e \cup (D\setminus P^\e) = \ext{P\subi{w,a}^\e}.\]
  As $(P^\e, Q_w^\e)$ is a surrounding pair in $D$, $P^\e$ is open in $D$ and $\ext{P\subi{w,a}^\e}\subseteq D$ is such that $\ext{Q^\e_a}\subseteq \ext{P\subi{w,a}^\e}$ it follows that
  \[\hom_k(P\subi{w,a}^\e, Q^\e_a) = \hom_k(P^\e\cap \ext{P\subi{w,a}^\e}, Q^\e_a) \cong\hom_k(\ext{P\subi{w,a}^\e}, \ext{Q^\e_a})\]
  by Lemma~\ref{lem:excision}
\end{proof}

% Because $\Q^\delta$ surrounds $P^\of$ in $D$ and $D\setminus \B\subseteq P^\of$ we have
% \[ D\subi{\omega,\alpha} = (P^\of\cup (D\setminus P^\of))\cap D\subi{\omega,\alpha}\subseteq P^\of\subi{\omega,\alpha} \cup (D\subi{\omega,\alpha}\cap (D\setminus P^\of))\]
% where $D\subi{\omega,\alpha}\cap (D\setminus P^\of) = (D\setminus P^\of)$ for all $\alpha\in\R$.
So we define the extensions
\[\ext{P^\e\subi{\omega-c\zeta, \alpha}} := P^\e\subi{\omega-c\delta, \alpha}\cup (D\setminus P^\of)\]
and
\[\ext{P^\e\subi{\omega+c\delta, \alpha}} := P^\e\subi{\omega+c\delta, \alpha}\cup (D\setminus P^\of)\]
of $P^\e_\alpha$ for all $\alpha\in\R$ and $\delta\leq\e\leq\zeta$.

\begin{lemma}\label{lem:p_interleave}
 If $Q_w^\e$ surrounds $P^\e$ in $D$ and $D\setminus B_{w + \e}\subseteq P^\e$ then
 \[ D\subi{w-c\e, a-c\e} \subseteq \ext{P\subi{w, a}^\e}\subseteq D\subi{w+c\e,a+c\e}.\]
\end{lemma}
\begin{proof}
  Suppose $x\in (P^\e\cap B\subi{w-c\e, a-c\e})\setminus B_{w+\e}$.
  Because $B_{w-\e}\subset B_{w+\e}$ we know $x\notin B_{w-\e}$ so $w+c\e < f(x)\leq a-c\e$ and there exists some $p\in P$ such that $\dist(x, p) < \e$.
  Because $f$ is $c$-Lipschitz it follows
  \[ f(p)\leq f(x) + c\dist(x, p) < a - c\e + c\e = a\]
  and
  \[ f(p)\geq f(x) - c\dist(x, p) > w+c\e-c\e = w.\]
  So $x\in P\subi{w,a}^\e$.

  Now, suppose $x\in P\subi{w,a}^\e\setminus B_{w+c\e}$.
  So $w+c\e < f(x)$ and there exists some $p\in P\subi{w,a}$ such that $\dist(x,p) < \e$.
  Because $f$ is $c$-Lipschitz it follows
  \[ f(x) \leq f(p) + c\dist(x,p) < a + c\e.\]
  So $x\in B\subi{w+c\e, a+c\e}\setminus B_{w+c\e}$.

  Because $D\setminus B_{w+c\e}\subseteq P^\e$ we know that $D\setminus P^\e \subseteq B_{w+c\e}$, so
  \[D\subi{w-c\e, a-c\e}\setminus B_{w+c\e} \subseteq P\subi{w,a}^\e\setminus B_{w+c\e}\subseteq D\subi{w+c\e, a+c\e}\setminus B_{w+c\e}\]
  implies
  \[ D\subi{w-c\e, a-c\e}\subseteq P\subi{w,a}^\e\cup (D\setminus P^\e) = \ext{P\subi{w,a}^\e} \subseteq D\subi{w+c\e, a+c\e} \]
  as desired.
\end{proof}


% Because $\Q^\delta$ surrounds $\P$ in $D$ and $D\setminus \B\subseteq \P$ we have
% \[ B_{\alpha-c\of} = (\P\cup (D\setminus \P))\cap B_{\alpha -c\of}\subseteq \P\subi{\alpha} \cup (B_{\alpha - c\of}\cap (D\setminus \P))\]
% where $B_{\alpha - c\of}\cap (D\setminus \P) = (D\setminus \P)$ for $\alpha\geq \omega+c\of$.
% So we define the extension $\ext{\P_\alpha} := \P_\alpha\cup (D\setminus \P)$ of $\P_\alpha$ for $\alpha\geq\omega+c\of$.
% So our assumptions imply that we have the following sequence of inclusions by Lemma~\ref{lem:surround_and_cover}.
% \[ \b\subseteq \ext{\Q^\of}\subseteq \B\subseteq\ext{\QQ^\of}\subseteq \BB.\]
%
% Because the relative homology of a pair $(X, A)$ is not well defined for $A\not\subseteq X$ we introduce the following notation.
%
% \begin{align*}
%   \FQ_\alpha &:= \begin{cases}
%     \ext{\P_\alpha}&\text{ if } \alpha < \omega-c\of\\
%     \ext{\Q^\of}&\text{ otherwise.}
%   \end{cases}&
%   \FQ_\alpha' &:= \begin{cases}
%     \FQ_\alpha&\text{ if } \alpha < \omega+c\of\\
%     \ext{\QQ^\of}&\text{ otherwise. }
%   \end{cases}
% \end{align*}
% \begin{align*}
%   \FB_\alpha &:= \begin{cases}
%     D_\alpha&\text{ if } \alpha < \omega-2c\of\\
%     \b&\text{ otherwise.}
%   \end{cases}&
%   \FB_\alpha' &:= \begin{cases}
%     D_\alpha&\text{ if } \alpha < \omega\\
%     \B&\text{ otherwise.}
%   \end{cases}&
% % \end{align*}
% % \begin{align*}
%   \FB'' &:= \begin{cases}
%     D_\alpha&\text{ if } \alpha < \omega+2c\of\\
%     \BB&\text{ otherwise.}
%   \end{cases}
% \end{align*}
%
% Because all maps are induced by inclusion the following diagram commutes for all $\alpha$.
% % \[(\{(\ext{P_\alpha},\FQ_\alpha)\},\{(\ext{P_\alpha},\FQ_\alpha')\}),\]
% % \[(\{(D_\alpha, \FB_\alpha)\}, \{(D_\alpha,\FB_\alpha')\}),\]
% % \[(\{(D_\alpha, \FB_\alpha')\},\{(D_\alpha,\FB_\alpha'')\}),\]
% % such that the following diagram commutes for all $\alpha\in\R$.
% \begin{equation}\label{dgm:interleaving2}
% \begin{tikzcd}
%   \hom_k(D_{\alpha-c\of}, \FB_{\alpha-c\of})\arrow{r}{f_{\alpha-c\delta}}\arrow{d}{\gamma_{\alpha-c\delta}} &
%   \hom_k(\ext{P^\of_\alpha},\FQ_\alpha)\arrow{r}{m_\alpha}\arrow{d}{\lambda_\alpha} &
%   \hom_k(D_{\alpha+c\of}, \FB_{\alpha+c\of}')\arrow{d}{\pi_{\alpha+c\of}}\\
%   %
%   \hom_k(D_{\alpha-c\of}, \FB_{\alpha-c\of}')\arrow{r}{g_{\alpha-c\of}} &
%   \hom_k(\ext{P^\of_\alpha}, \FQ_\alpha')\arrow{r}{n_\alpha} &
%   \hom_k(D_{\alpha+c\of}, \FB_{\alpha+c\of}'')
% \end{tikzcd}\end{equation}

Suppose $\b$ surrounds $D$ in $\X$, $D\setminus\B\subseteq P^of$, and $\Q^\of$ surrounds $P^of$ in $D$ such that
\[ \b\cap P^of \subseteq \Q^\of\subseteq \B\cap P^of\subseteq \QQ^\of\subseteq \BB.\]
By Lemma~\ref{lem:surround_and_cover} and Lemma~\ref{lem:p_interleave} it follows that for all $\alpha\in\R$ and $\delta\leq\e\leq\zeta$.
\[ (D\subi{\omega-c(\delta+\zeta),\alpha-c\delta},\b)\subseteq (\ext{P^\e\subi{\omega-c\zeta,\alpha}},\ext{\Q^\e})\subseteq (D\subi{\omega,\alpha+c\e},\B)\]
and
\[ (D\subi{\omega,\alpha-c\delta},\B)\subseteq (\ext{P^\e\subi{\omega+c\delta,\alpha}},\ext{\QQ^\e})\subseteq (D\subi{\omega+c(\delta+\zeta),\alpha+c\e},\BB).\]
Therefore the following diagram of maps induced by inclusion commutes.
% \[(\{(\ext{P_\alpha},\FQ_\alpha)\},\{(\ext{P_\alpha},\FQ_\alpha')\}),\]
% \[(\{(D_\alpha, \FB_\alpha)\}, \{(D_\alpha,\FB_\alpha')\}),\]
% \[(\{(D_\alpha, \FB_\alpha')\},\{(D_\alpha,\FB_\alpha'')\}),\]
% such that the following diagram commutes for all $\alpha\in\R$.
\begin{equation}\label{dgm:interleaving2}
\begin{tikzcd}
  \hom_k(D\subi{\omega-c(\delta+\zeta), \alpha-c\of}, \b)\arrow{r}{f_{\alpha-c\delta}}\arrow{d}{\gamma_{\alpha-c\delta}} &
  \hom_k(\ext{P^\e\subi{\omega-c\zeta,\alpha}},\ext{\Q^\e})\arrow{r}{m_\alpha}\arrow{d}{\lambda_\alpha} &
  \hom_k(D\subi{\omega,\alpha+c\e}, \B)\arrow{d}{\pi_{\alpha+c\e}}\\
  %
  \hom_k(D\subi{\omega,\alpha-c\of}, \B)\arrow{r}{g_{\alpha-c\of}} &
  \hom_k(\ext{P^\e\subi{\omega+c\of,\alpha}}, \ext{\QQ^\e})\arrow{r}{n_\alpha} &
  \hom_k(D\subi{\omega+c(\delta+\zeta),\alpha+c\e}, \BB)
\end{tikzcd}\end{equation}

% \begin{lemma}\label{lem:pt_interleaving}
%   If $\hom_k(\b\to\B)$ is surjective and $\hom_k(\B)\cong \hom_k(\BB)$ for all $k$ then for all $\delta\leq\e\leq\zeta$ the $k$th persistent homology modules of \[\{(P^\e\subi{\omega-c\of,\alpha},\Q^\e)\to(P^\e\subi{\omega+c\of,\alpha},\QQ^\e)\}\] and $\{(D\subi{\omega,\alpha}, \B)\}$ are $c\e$-interleaved.
% \end{lemma}
% \begin{proof}
%   Let $\U, \V, \W$ be the $k$th persistent homology modules of $\{(D\subi{\omega-c(\delta+\zeta), \alpha}, \b)\}$, $\{(D\subi{\omega,\alpha}, \B)\}$, $\{(D\subi{\omega+c(\delta+\zeta),\alpha}, \BB)\}$, and $\S, \T$ the $k$th persistent homology modules of $\{(\ext{P^\e\subi{\omega-c\zeta,\alpha}},\ext{\Q^\e})\}$ and $\{(\ext{P^\e\subi{\omega+c\of,\alpha}},\ext{\QQ^\e})\}$ respectively.
%   Let $\Gamma\in\Hom(\U,\V)$, $\Lambda\in\Hom(\S, \T)$, and $\Pi\in\Hom(\V,\W)$ be homomorphisms induced by inclusion.
%   Because Diagram~\ref{dgm:interleaving2} commutes for all $\alpha$ we have the following homomorphisms of degree $c\delta$ and $c\e$ induced by inclusion.
%   \begin{align*}
%     F&\in\Hom^{c\delta}(\U,\S)& M&\in\Hom^{c\e}(\S,\V)\\
%     G&\in\Hom^{c\delta}(\V,\T)& N&\in\Hom^{c\e}(\T,\W)
%   \end{align*}
%   Because all maps are induced by inclusion we have a partial $c\e$-interleavings
%   \begin{align*}
%     \Phi(F, G; M)&\in\Hom^{c\e}(\im~\Gamma, \im~\Lambda), & \Psi(M, N; G)&\in\Hom^{c\e}(\im~\Lambda, \im~\Pi).
%   \end{align*}
%
%   By applying Lemma~\ref{lem:five} to the long exact sequences of the pairs $(D\subi{\omega-c(\delta+\zeta),\alpha},\b)$ and $(D\subi{\omega,\alpha},\B)$ our assumption that $\hom_k(\b\to\B)$ is surjective for all $k$ implies $\gamma_\alpha : \hom_k(D\subi{\omega-c(\delta+\zeta),\alpha},\b)\to \hom_k(D\subi{\omega,\alpha},\B)$ is surjective for all $\alpha\in\R$.
%   So $\Gamma : \U\to \V$ is an epimorphism.
%   Similarly, the assumption that $\hom_k(\B)\cong \hom_k(\BB)$ implies $\pi_\alpha : \hom_k(D\subi{\omega,\alpha},\B)\to \hom_k(D\subi{\omega+c(\delta+\zeta),\alpha},\BB)$ is an isomorphism by applying Lemma~\ref{lem:five} to the long exact sequences of the pairs $(D\subi{\omega,\alpha},\B)$ and $(D\subi{\omega+c(\delta+\zeta),\alpha},\BB)$.
%   So $\Pi : \V\to\W$ is an isomorphism of persistence modules (and therefore a monomorphism).
%   As \[\im~\lambda_\alpha \cong \im~\hom_k((P\subi{\omega-c\zeta,\alpha}^\e,\Q^\e)\to (P\subi{\omega+c\delta,\alpha}^\e,\QQ^\e))\]
%   for all $\alpha$ by Lemma~\ref{lem:extension_apply} the result follows from Theorem~\ref{thm:interleaving_main}.
%
%   % As we have shown
%   % As $(\{(\ext{P_\alpha},\FQ_\alpha)\},\{(\ext{P_\alpha},\FQ_\alpha')\})$, $(\{(D_\alpha, \FB_\alpha)\}, \{(D_\alpha,\FB_\alpha')\})$, and $(\{(D_\alpha, \FB_\alpha')\},\{(D_\alpha,\FB_\alpha'')\})$ are compatible pairs of filtrations such that Digram~\ref{dgm:interleaving} commutes with $f_\alpha$ surjective and $h_\alpha$ injective for all $\alpha\in\R$ the result follows from Theorem~\ref{thm:interleaving}.
%
%
% \end{proof}

\begin{lemma}\label{lem:pt_interleaving}
  If $\hom_k(\b\to\B)$ is surjective and $\hom_k(\B)\cong \hom_k(\BB)$ for all $k$ then for all $k$ and $\alpha\leq\beta$
  \[\hom_k\left((D\subi{\omega-c(\delta+\zeta),\alpha},B_{\omega-c(\delta+\zeta)})\hookrightarrow (D\subi{\omega,\beta},B_{\omega})\right)\]
  is surjective and
  \[ \hom_k\left( (D\subi{\omega,\alpha},B_\omega)\hookrightarrow (D\subi{\omega+c(\delta+\zeta),\beta},B_{\omega+c(\delta+\zeta)}) \right)\]
  is an isomorphism.
\end{lemma}
\begin{proof}
  Let $\U, \V, \W$ be the $k$th persistent homology modules of $\{(D\subi{\omega-c(\delta+\zeta), \alpha}, \b)\}$, $\{(D\subi{\omega,\alpha}, \B)\}$, $\{(D\subi{\omega+c(\delta+\zeta),\alpha}, \BB)\}$.
  Let $\Gamma\in\Hom(\U,\V)$ and $\Pi\in\Hom(\V,\W)$ be homomorphisms induced by inclusion.

  By applying Lemma~\ref{lem:five} to the long exact sequences of the pairs $(D\subi{\omega-c(\delta+\zeta),\alpha},\b)$ and $(D\subi{\omega,\alpha},\B)$ our assumption that $\hom_k(\b\to\B)$ is surjective for all $k$ implies $\gamma_\alpha : \hom_k(D\subi{\omega-c(\delta+\zeta),\alpha},\b)\to \hom_k(D\subi{\omega,\alpha},\B)$ is surjective for all $\alpha\in\R$.
  So $\Gamma : \U\to \V$ is an epimorphism.
  Similarly, the assumption that $\hom_k(\B)\cong \hom_k(\BB)$ implies $\pi_\alpha : \hom_k(D\subi{\omega,\alpha},\B)\to \hom_k(D\subi{\omega+c(\delta+\zeta),\alpha},\BB)$ is an isomorphism by applying Lemma~\ref{lem:five} to the long exact sequences of the pairs $(D\subi{\omega,\alpha},\B)$ and $(D\subi{\omega+c(\delta+\zeta),\alpha},\BB)$.
  So $\Pi : \V\to\W$ is an isomorphism of persistence modules (and therefore a monomorphism).

  % As we have shown
  % As $(\{(\ext{P_\alpha},\FQ_\alpha)\},\{(\ext{P_\alpha},\FQ_\alpha')\})$, $(\{(D_\alpha, \FB_\alpha)\}, \{(D_\alpha,\FB_\alpha')\})$, and $(\{(D_\alpha, \FB_\alpha')\},\{(D_\alpha,\FB_\alpha'')\})$ are compatible pairs of filtrations such that Digram~\ref{dgm:interleaving} commutes with $f_\alpha$ surjective and $h_\alpha$ injective for all $\alpha\in\R$ the result follows from Theorem~\ref{thm:interleaving}.


\end{proof}
