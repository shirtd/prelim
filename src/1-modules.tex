% !TeX root = ../main.tex

\begin{definition}[Persistence Module]
  A \textbf{persistence module} $\S$ over $\R$ is an indexed family of vector spaces $\{S_\alpha\}$ and linear maps $\{s_\alpha^\beta : S_\alpha\to S_\beta\}$ such that $s^\gamma_\beta\circ s_\alpha^\beta = s_\alpha^\gamma$ whenever $\alpha\leq\beta\leq\gamma$ and $s_\alpha^\alpha$ is the identity on $S_\alpha$.
\end{definition}

For a persistence module $\S$ we will also use $S[\alpha]$ to denote the vector space $S_\alpha$ and $s[\alpha,\beta]$ to denote the linear maps $s_\alpha^\beta$ when additional notation is required.

\begin{definition}[Persistence Module Homomorphism]
  A \textbf{homomorphism} $\Lambda$ between two $\R$-persistence modules $\S, \T$ is a collection of linear maps $\{\lambda_\alpha : S_\alpha\to T_\alpha\}$ such that the following diagram commutes for all $\alpha\leq\beta$.
  \begin{equation}\label{dgm:homomorphism}
    \begin{tikzcd}
      S_\alpha\arrow{r}{s_\alpha^\beta}\arrow{d}{\lambda_\alpha} &
      S_\beta\arrow{d}{\lambda_\beta}\\
      %
      T_\alpha\arrow{r}{t_\alpha^\beta} &
      T_\beta
  \end{tikzcd}\end{equation}
  The space of homomorphisms from $\S$ to $\T$ will be denoted $\Hom(\S, \T)$.
\end{definition}

\begin{definition}[Shifted Homomorphism]
  A \textbf{homomorphism of degree $\delta$} is a collection $F$ of linear maps $f_\alpha : U_\alpha\to S_{\alpha+\delta}$ such that the following diagram commutes for all $\alpha\leq\beta$.

  \begin{equation}\label{dgm:shifted_homomorphism}
    \begin{tikzcd}
      U_\alpha\arrow{r}{u_\alpha^\beta}\arrow{d}{f_\alpha} &
      U_\beta\arrow{d}{f_\beta}\\
      %
      S_{\alpha+\delta}\arrow{r}{s_{\alpha+\delta}^{\beta+\delta}} &
      S_{\beta +\delta}
  \end{tikzcd}\end{equation}
  The space of homomorphisms of degree $\delta$ from $\U$ to $\S$ will be denoted $\Hom^\delta(\U, \S)$.
\end{definition}

Noting that $\Hom^\delta(\U,\V)\subseteq\Hom^{\delta'}(\U,\V)$ for all $0\leq\delta\leq\delta'$ we will define particular shifted homomorphisms with the assumption that $\Hom^\delta(\U,\V) = \Hom(\U,\V)$ for $\delta = 0$.
For $\Gamma\in\Hom(\U,\V)$ let $\Gamma[\delta]\in\Hom^\delta(\U,\V)$ denote the homomorphism of degree $\delta$ defined as the family of linear maps
\[\{\gamma_\alpha[\delta] := v_\alpha^{\alpha+\delta}\circ \gamma_\alpha : U_\alpha\to V_{\alpha+\delta}\}.\]

Using our alternative notation we will write
\[\gamma[\alpha;\delta] := v[\alpha,\alpha+\delta]\circ\gamma[\alpha] : U[\alpha]\to V[\alpha+\delta]\]
to denote a map $\gamma_\alpha[\delta]$ of $\Gamma[\delta]$.

\begin{lemma}\label{lem:trans_shift}
  If $F\in \Hom^\delta(\U,\S)$ and $F'\in\Hom^{\delta'}(\S,\S')$ then $F'\circ F\in\Hom^{\delta+\delta'}(\U,\S')$.
\end{lemma}
\begin{proof}
  Because $F'\in \Hom^{\delta'}(\S,\S')$ we have $f_{\beta}'\circ s_\alpha^\beta = {s_{\alpha+\delta'}^{\beta+\delta'}}'\circ f_{\alpha+\delta'}'$ for all $\alpha\leq\beta$.
  Because $F\in\Hom^\delta(\U,\S)$ we have $f_{\beta-\delta}\circ u_{\alpha-\delta}^{\beta-\delta} = s_\alpha^\beta\circ f_{\alpha-\delta}$ for all $\alpha\leq\beta$.
  So
  \begin{align*}
    f_{\beta}'\circ (f_{\beta-\delta}\circ u_{\alpha-\delta}^{\beta-\delta})
      &= (f_{\beta}'\circ s_\alpha^\beta)\circ f_{\alpha-\delta}\\
      &= {s_{\alpha+\delta'}^{\beta+\delta'}}'\circ f_{\alpha+\delta'}'\circ f_{\alpha-\delta}
  \end{align*}
  so $F'\circ F\in\Hom^{\delta+\delta'}(\U,\S')$.
\end{proof}

\begin{definition}[Interleaving]
  Two persistence modules $\U$ and $\S$ are \textbf{$\delta$-interleaved} if there exist homomorphisms $F\in\Hom^\delta(\U, \S)$ and $G \in\Hom^\delta(\S,\U)$ such that the following diagrams commute for all $\alpha$.

  \begin{minipage}{0.45\textwidth}
  \begin{equation}\label{dgm:interleaving1}
    \begin{tikzcd}
      U_{\alpha-\delta}\arrow{rr}{u_{\alpha-\delta}^{\alpha+\delta}}\arrow{dr}{f_{\alpha-\delta}} & &
      U_{\alpha+\delta}\\
      %
      & S_{\alpha}\arrow{ur}{g_\alpha} &
  \end{tikzcd}\end{equation}
  \end{minipage}
  \begin{minipage}{0.45\textwidth}
  \begin{equation}\label{dgm:interleaving2}
    \begin{tikzcd}
      & U_{\alpha}\arrow{dr}{f_\alpha} &\\
      %
      S_{\alpha-\delta}\arrow{rr}{s_{\alpha-\delta}^{\alpha+\delta}}\arrow{ur}{g_{\alpha-\delta}} & &
      S_{\alpha+\delta}
  \end{tikzcd}\end{equation}
  \end{minipage}
\end{definition}

\subsection{Weak Interleavings}

\begin{definition}[Weak Interleaving]
  For $I\in\Hom^{2\delta}(\U,\V)$ a pair $(F, M)\in \Hom^\delta(\U,\S)\times\Hom^\delta(\S,\V)$ is a \textbf{weak $\delta$-interleaving} of $I$ with $\S$ if $I = M\circ F$.
  If $J\in\Hom^{\delta'}(\S,\T)$ and $(F,N)\in\Hom^\delta(\U,\S)\times\Hom^\delta(\T,\V)$ is a weak $\delta$-interleaving of $I$ with $J$ if $I = N\circ J\circ F$.
\end{definition}

\begin{lemma}\label{lem:left}
  Let $I\in\Hom^{4\delta}(\U,\V)$, $J\in\Hom^{2\delta}(\S,\T)$ and suppose $(F, N)\in\Hom^{\delta}(\U,\S)\times\Hom^\delta(\T,\V)$ is a weak $\delta$-interleaving of $I$ with $J$.

  If $(F', M')\in\Hom^\delta(\S,\S')\times\Hom^\delta(\S',\T)$ is a weak $\delta$-interleaving of $J$ with $\S'$ then
  \[(F'\circ F, N\circ M')\in\Hom^{2\delta}(\U,\S')\times \Hom^{2\delta}(\S',\V)\]
  is a weak $2\delta$-interleaving of $I$ with $\S'$.
\end{lemma}
\begin{proof}
  By Lemma~\ref{lem:trans_shift} we have $F'\circ F\in\Hom^{2\delta}(\U,\S')$ and $N\circ M'\in \Hom^{2\delta}(\S',\V)$.
  If $(F', M')$ is a weak $\delta$-interleaving of $J$ with $\S'$ then $J = M'\circ F'$.
  By our hypothesis that $(F, N)$ is a weak $\delta$-interleaving of $I$ with $J$
  \[ I = N\circ J\circ F = (N\circ M')\circ (F'\circ F).\]
  We may therefore conclude that $(F'\circ F, N\circ M')\in\Hom^{2\delta}(\U,\S')\times \Hom^{2\delta}(\S',\V)$ is a weak $2\delta$-interleaving of $I$ with $\S'$.
\end{proof}

\begin{lemma}\label{lem:right}
  Let $I\in\Hom^{2\delta}(\U,\V)$, $I'\in\Hom^{4\delta}(\U',\V')$ and suppose $(F, M)\in\Hom^\delta(\U,\S)\times\Hom^\delta(\S,\V)$ is a weak $\delta$-interleaving of $I$ with $\S$.

  If $(F',N')\in\Hom^\delta(\U',\U)\times\Hom^\delta(\V,\V')$ is a weak $\delta$-interleaving of $I'$ with $I$ then
  \[(F\circ F', N'\circ M)\in\Hom^{2\delta}(\U',\S)\times\Hom^{2\delta}(\S,\V')\]
  is a weak $2\delta$-interleaving of $I'$ with $\S$.
\end{lemma}
\begin{proof}
  By Lemma~\ref{lem:trans_shift} we have $F\circ F'\in \Hom^{2\delta}(\U',\S)$ and $N'\circ M\in \Hom^{2\delta}(\S,\V')$.
  By our hypothesis that $(F, M)$ is a weak $\delta$-interleaving of $I$ with $\S$ we know $I = M\circ F$.
  If $(F',N')$ is a weak $\delta$-interleaving of $I'$ with $I$ then $I' = N'\circ I\circ F'$.
  \[ I' = N'\circ I\circ F' = (N'\circ M)\circ (F\circ F').\]
  We may therefore conclude that $(F\circ F', N'\circ M)\in\Hom^{2\delta}(\U',\S)\times\Hom^{2\delta}(\S,\V')$ is a weak $2\delta$-interleaving of $I'$ with $\S$.
\end{proof}

\subsection{Image Persistence Modules}

\begin{definition}[Image Persistence Module]
  The \textbf{image persistence module} of a homomorphism $\Gamma\in\Hom(\U,\V)$ is the family of subspaces $\{\Gamma_\alpha :=\im~\gamma_\alpha\}$ in $\V$ along with linear maps $\{\gamma_\alpha^\beta := v_\alpha^\beta\rest_{\im~\gamma_\alpha} : \Gamma_\alpha\to\Gamma_\beta\}$ and will be denoted by $\im~\Gamma$.
\end{definition}

\begin{definition}[Image Module Homomorphism]
  Given $\Gamma\in\Hom(\U,\V)$ and $\Lambda\in\Hom(\S,\T)$ along with $(F,G)\in\Hom^\delta(\U,\S)\times\Hom^\delta(\V,\T)$ let $\Phi(F, G) : \im~\Gamma\to\im~\Lambda$ denote the family of linear maps $\{\phi_\alpha := g_\alpha\rest_{\Gamma_\alpha} : \Gamma_\alpha\to\Lambda_{\alpha+\delta}\}$.
  $\Phi(F, G)$ is an \textbf{image module homomorphism of degree $\delta$} if the following diagram commutes for all $\alpha\leq\beta$.

  \begin{equation}\label{dgm:image_homomorphism}
    \begin{tikzcd}[column sep=large]
        U_\alpha\arrow{r}{\gamma_\alpha[\beta-\alpha]}\arrow{d}{f_\alpha} &
      V_\beta\arrow{d}{g_\beta}\\
      %
      S_{\alpha+\delta}\arrow{r}{\lambda_{\alpha+\delta}[\beta-\alpha]} &
      T_{\beta +\delta}
  \end{tikzcd}\end{equation}
  The space of image module homomorphisms of degree $\delta$ between $\im~\Gamma$ and $\im~\Lambda$ will be denoted $\Hom^\delta(\im~\Gamma,\im~\Lambda)$.
\end{definition}

Recall that $\gamma_\alpha[\beta-\alpha] = v_\alpha^\beta\circ\gamma_\alpha$ and $\lambda_\alpha[\beta-\alpha] = t_\alpha^\beta\circ\lambda_\alpha$.
Because $\im~\gamma_\alpha[\beta-\alpha] = \im~\gamma_\alpha^\beta$ and $\im~\lambda_{\alpha}[\beta-\alpha] = \im~\lambda_\alpha^\beta$ for all $\alpha\leq\beta$ the commutativity of Diagram~\ref{dgm:image_homomorphism} implies the following diagram of images commutes.
\begin{equation}\label{dgm:shifted_homomorphism}
  \begin{tikzcd}[column sep=large]
    \Gamma_\alpha\arrow{r}{\gamma_\alpha^\beta}\arrow{d}{\phi_\alpha} &
    \Gamma_\beta\arrow{d}{\phi_\beta}\\
    %
    \Lambda_{\alpha+\delta}\arrow{r}{\lambda_{\alpha+\delta}^{\beta+\delta}} &
    \Lambda_{\beta +\delta}
\end{tikzcd}\end{equation}

We note that whenever $\Gamma\in\Hom(\U,\V)$ and $\Lambda\in\Hom(\S,\T)$ the assumption that $\Phi(F, G)\in\Hom^\delta(\im~\Gamma, \im~\Lambda)$ implies that $F\in\Hom^\delta(\U,\S)$ and $G\in\Hom^\delta(\V,\T)$.

\begin{lemma}\label{lem:image_composition}
  Suppose $\Gamma\in\Hom(\U,\V)$, $\Lambda\in\Hom(\S,\T)$, and $\Lambda'\in\Hom(\S',\T')$.
  If $\Phi(F, G)\in\Hom^\delta(\im~\Gamma, \im~\Lambda)$ and $\Phi'(F', G')\in\Hom^{\delta'}(\im~\Lambda, \im~\Lambda')$ then $\Phi''(F'\circ F, G'\circ G)\in\Hom^{\delta+\delta'}(\im~\Gamma,\im~\Lambda')$.
\end{lemma}
\begin{proof}
  Because $\Phi(F, G)$ is an image module homomorphism of degree $\delta$
  \[ g_{\beta-\delta}\circ\gamma_{\alpha-\delta}[\beta-\alpha] = \lambda_\alpha[\beta-\alpha]\circ f_{\alpha-\delta}.\]
  Because $\Phi'(F', G')$ is an image module homomorphism of degree $\delta'$
  \[ g_{\beta}'\circ\lambda_{\alpha}[\beta-\alpha] = \lambda_{\alpha +\delta'}'[\beta-\alpha]\circ f_{\alpha}'.\]
  Therefore, for all $\alpha\leq\beta$,
  \begin{align*}
    g_\beta'\circ (g_{\beta-\delta}\circ \gamma_{\alpha-\delta}[\beta-\alpha]) &= (g_\beta'\circ \lambda_\alpha[\beta-\alpha])\circ f_{\alpha-\delta}\\
      &=\lambda_{\alpha+\delta'}[\beta-\alpha]\circ f_\alpha'\circ f_{\alpha-\delta}.
  \end{align*}
  So $\Phi''(F'\circ F, G'\circ G)\in\Hom^{\delta+\delta'}(\im~\Gamma,\im~\Lambda')$ as desired.
  % \[g_\beta\circ (v_\alpha^\beta\circ \gamma_\alpha) = (t_{\alpha+\delta}^{\beta+\delta}\circ\lambda_{\alpha+\delta})\circ f_\alpha\]
  % for all $\alpha$.
  % Because $\Psi(M, N)$ is an image module homomorphism of degree $\delta'$
  % \[n_\beta\circ (_\alpha^\beta\circ \gamma_\alpha) = (t_{\alpha+\delta}^{\beta+\delta}\circ\lambda_{\alpha+\delta})\circ f_\alpha\]

\end{proof}

\subsection{Partial Interleavings of Image Modules}

\begin{definition}[Partial Interleaving of Image Modules]
  For $\Gamma\in\Hom(\U,\V)$ and $\Lambda\in\Hom(\S,\T)$ an image module homomorphism $\Phi(F, G)\in\Hom^\delta(\im~\Gamma,\im~\Lambda)$ along with $M\in\Hom^\delta(\S,\V)$ is a \textbf{left $\delta$-interleaving of image modules} if $(F, M)$ is a weak $\delta$-interleaving of $\Gamma[2\delta]$ with $\S$.
  $\Phi(F, G)$ is a \textbf{right $\delta$-interleaving of image modules} if $(M, G)$ is a weak $\delta$-interleaving of $\Lambda[2\delta]$ with $\V$.

  An image module homomorphism $\Phi(F, G)$ is a \textbf{partial $\delta$-interleaving of image modules}, and denoted $\Phi_M(F, G)$, if it is both a left and right $\delta$-interleaving of image modules.
\end{definition}

\begin{lemma}\label{thm:interleaving_main}
  Suppose $\Gamma\in\Hom(\U,\V)$, $\Pi\in\Hom(\V,\W)$, and $\Lambda\in\Hom(\S, \T)$.

  If $\Phi_M(F, G)\in\Hom^\delta(\im~\Gamma, \im~\Lambda)$ and $\Psi_G(M, N)\in\Hom^\delta(\im~\Lambda, \im~\Pi)$ are partial $\delta$-interleavings of image modules such that $\Gamma$ is a epimorphism and $\Pi$ is a monomorphism then $\im~\Lambda$ is $\delta$-interleaved with $\V$.
\end{lemma}
\begin{proof}
  For ease of notation let $\Phi$ denote $\Phi_M(F, G)$ and $\Psi$ denote $\Psi_G(M, N)$.

  If $\Gamma$ is an epimorphism $\gamma_\alpha$ is surjective so $\Gamma_\alpha = V_\alpha$ and $\phi_{\alpha} = g_{\alpha}\rest_{\Gamma_\alpha} = g_\alpha$ for all $\alpha$.
  So $\im~\Gamma = \V$ and $\Phi\in\Hom^\delta(\V,\im~\Lambda)$.

  If $\Pi$ is a monomorphism then $\pi_\alpha$ is injective so we can define a natural isomorphism $\pi_\alpha^{-1} : \Pi_\alpha\to V_\alpha$ for all $\alpha$.
  Let $\Psi^*$ be defined as the family of linear maps $\{\psi_\alpha^* := \pi^{-1}_\alpha \circ \psi_\alpha : \Lambda_\alpha\to V_{\alpha+\delta}\}$.
  Because $\Psi$ is a partial $\delta$-interleaving of image modules, $n_\alpha\circ\lambda_\alpha = \pi_{\alpha+\delta}\circ m_\alpha$.
  So, because $\psi_\alpha = n_\alpha\rest_{\Lambda_\alpha}$ for all $\alpha$,
  \begin{align*}
    \im~\psi_\alpha^* &= \im~\pi^{-1}_{\alpha+\delta}\circ\psi_\alpha\\
                      &= \im~\pi^{-1}\circ (n_\alpha\circ\lambda_\alpha)\\
                      &= \im~\pi^{-1}\circ (\pi_{\alpha+\delta}\circ m_\alpha)\\
                      &= \im~ m_\alpha.
  \end{align*}
  It follows that $\im~v_{\alpha+\delta}^{\beta+\delta}\circ\psi_\alpha^* = \im~v_{\alpha+\delta}^{\beta+\delta}\circ m_\alpha$

  Similarly, because $\Psi$ is a $\delta$-interleaving of image modules $n_\beta\circ t_\alpha^\beta\circ \lambda_\alpha = w_{\alpha+\delta}^{\beta+\delta}\circ\pi_{\alpha+\delta}\circ m_\alpha$.
  Moreover, because $\Pi$ is a homomorphism of persistence modules, $w_{\alpha+\delta}^{\beta+\delta}\circ\pi_{\alpha+\delta} = \pi_{\beta+\delta}\circ v_{\alpha+\delta}^{\beta+\delta}$, so
  \[ n_\beta\circ t_\alpha^\beta\circ \lambda_\alpha = \pi_{\beta+\delta}\circ v_{\alpha+\delta}^{\beta+\delta}\circ m_\alpha.\]
  As $\psi_\beta\circ\lambda_\alpha^\beta = n_\beta\circ\lambda_\alpha^\beta = n_\beta\circ t_\alpha^\beta\rest_{\Lambda_\alpha}$ it follows
  \begin{align*}
    \im~\psi_\beta^*\circ\lambda_\alpha^\beta &= \im~\pi^{-1}_{\beta+\delta}\circ (n_\beta\circ t_\alpha^\beta\circ\lambda_\alpha)\\
      &= \im~\pi^{-1}_{\beta+\delta}\circ (\pi_{\beta+\delta}\circ v_{\alpha+\delta}^{\beta+\delta})\circ m_\alpha\\
      &= \im~v_{\alpha+\delta}^{\beta+\delta}\circ m_\alpha\\
      &= \im~v_{\alpha+\delta}^{\beta+\delta}\circ\psi_\alpha^*.
  \end{align*}
  So we may conclude that $\Psi^*\in\Hom^\delta(\im~\Lambda,\V)$.

  So $\Phi\in\Hom^\delta(\V,\im~\Lambda)$ and $\Psi_G^*\in\Hom^\delta(\im~\Lambda,\V)$.
  As we have shown, $\im~\psi_{\alpha-\delta}^* = \im~m_{\alpha-\delta}$ so $\im~\phi_\alpha\circ\psi_{\alpha-\delta}^* = \im~\phi_\alpha\circ m_{\alpha-\delta}$.
  Moreover, because $\gamma_\alpha$ is surjective $\phi_\alpha = g_\alpha$ and, because $\Phi$ is a partial $\delta$-interleaving of image modules, $g_\alpha\circ m_{\alpha-\delta} = t_{\alpha-\delta}^{\alpha+\delta}\circ \lambda_{\alpha-\delta}$.
  As $\lambda_{\alpha-\delta}^{\alpha+\delta} = t_{\alpha-\delta}^{\alpha+\delta}\rest_{\im~\lambda_{\alpha-\delta}}$ it follows that $\im~\phi_\alpha\circ\psi_{\alpha-\delta}^* = \im~\lambda_{\alpha-\delta}^{\alpha+\delta}$.

  Finally, $\psi_\alpha^*\circ\phi_\alpha = \pi_{\alpha+\delta}^{-1}\circ n_\alpha\circ g_{\alpha-\delta}$ where, because $\Psi$ is a partial $\delta$-interleaving of image modules, $n_\alpha\circ g_{\alpha-\delta} = w_{\alpha-\delta}^{\alpha+\delta}\circ\pi_{\alpha-\delta}$.
  Because $\Pi$ is a homomorphism of persistence modules $w_{\alpha-\delta}^{\alpha+\delta}\circ \pi_{\alpha-\delta} = \pi_{\alpha+\delta}\circ v_{\alpha-\delta}^{\alpha+\delta}$.
  Therefore,
  \begin{align*}
    \psi_\alpha^*\circ\phi_\alpha &= \pi_{\alpha+\delta}^{-1}\circ n_\alpha\circ g_{\alpha-\delta}\\
      &= \pi_{\alpha+\delta}^{-1}\circ (\pi_{\alpha+\delta}\circ v_{\alpha-\delta}^{\alpha+\delta})\\
      &= v_{\alpha-\delta}^{\alpha+\delta}
  \end{align*}
  which, along with $\phi_\alpha\circ\im~\psi_{\alpha-\delta}^* = \lambda_{\alpha-\delta}^{\alpha+\delta}$ implies Diagrams~\ref{dgm:interleaving1} and~\ref{dgm:interleaving2} commute with $\Phi\in\Hom^\delta(\V,\im~\Lambda)$ and $\Psi^*\in\Hom^\delta(\im~\Lambda, \V)$.
  We may therefore conclude that $\im~\Lambda$ and $\V$ are $\delta$-interleaved.

\end{proof}
