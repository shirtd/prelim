% !TeX root = ../main.tex

Let $D$ be a compact subset of $\X$.
Let $\dist(x, y) = \|x - y\|$ denote the distance between points $x,y\in D$ as a subspace of $\X$.
For $A\subset D$ and $x\in D$ let
\[\dist_A(x) = \min_{a\in A}\dist(x, a)\]
denote the distance from $x$ to the set $A$.
We will use open metric balls restricted to $D$ with the subspace topology
\[\ball_\e(x) = \{y\in D\mid \dist(x, y) < \e\}\]
and offsets
\[A^\e = \{x\in D\mid \dist_A(x) < \e\}.\]

Let $f : D\to \R$ be a $c$-Lipschitz function on $D$.
Let $B_a = f^{-1}(-\infty, a]$ denote the $a$-sublevel set of $f$.
For a subset $A$ of $D$ let $A_a := A\cap B_a$ denote the $a$-sublevelset of $f$ restricted to $A$.
Let $\overline{U} = \X\setminus U$ denote the complement of any subset $U\subset \X$ in $\X$.

Let $P$ be a finite subset of $D$ and $Q_a := P\cap B_a$ for $a\in\R$.
Let $\zeta\geq\of > 0 $ and $\omega\in \R$ be constants such that $P^\of\subseteq D$.

\begin{lemma}\label{lem:psurj}
  Let $i : \hom_0(\cmp{\QQ^\of}, \cmp{P^\of})\to \hom_0(\cmp{\Q^\of}, \cmp{P})$.

  If $\B$ surrounds $D$ in $\X$ then $\dim~\hom_0(\cmp{\B}, \cmp{D})\geq \rk~i$.
\end{lemma}
\begin{proof}
  Choose a basis for $\im~i$ such that each basis element is represented by a point in $P^\of\setminus \QQ^\of$.
  Let $x\in P^\of\setminus \QQ^\of$ be such that $i[x] \neq 0$.
  So there exits some $p\in P$ such that $\dist(p, x) < \delta$ and $p\notin \QQ$, otherwise $x\in\QQ^\of$.
  Therefore, because $f$ is $c$-Lipschitz,
  \[ f(x)\geq f(p) - c\dist(x, p) > \fenn - c\of =\omega.\]

  So $x\in\cmp{\B}$ and, because $x\in P^\of\subseteq D$, $x\in D\setminus \B$.
  Because $i$ and $\ell : \hom_0(\cmp{\B}, \cmp{D})\to \hom_0(\cmp{\Q^\of}, \cmp{P^\of})$ are induced by inclusion $\ell[x] = i[x]\neq 0$ in $\hom_0(\cmp{\Q^\of}, \cmp{P^\of})$.
  That is, every element of $\im~i$ has a preimage in $\hom_0(\cmp{\B}, \cmp{D})$, so we may conclude that $\dim~\hom_0(\cmp{\B}, \cmp{D})\geq \rk~i$.
\end{proof}

Note that, while there is a surjective map from $\hom_0(\cmp{\B}, \cmp{D})$ to $\im~i$ this map is not necessarily induced by inclusion, as $\QQ^\of\not\subseteq \B$.
We therefore must introduce a larger space $\BB$ that contains $\QQ^\of$ in order to provide a computable criteria for the injectivity of $\ell : \hom_0(\cmp{\B}, \cmp{D})\to\hom_0(\cmp{\Q^\of}, \cmp{P^\of})$.

\[ \begin{tikzcd}
  (P^\of, \Q^\of) \arrow[hookrightarrow]{r}\arrow[hookrightarrow]{d} &
  (P^\of, \QQ^\of) \arrow[hookrightarrow]{d} \\
  %
  (D, \bb) \arrow[hookrightarrow]{r} &
  (D, \BB),
\end{tikzcd}\begin{tikzcd}
  (\cmp{\BB},\cmp{D})\arrow[hookrightarrow]{d}\arrow[hookrightarrow]{r} &
  (\cmp{\bb}, \cmp{D}) \arrow[hookrightarrow]{d}\\
  %
  (\cmp{\QQ^\of}, \cmp{P^\of}) \arrow[hookrightarrow]{r} &
  (\cmp{\Q^\of}, \cmp{P^\of}).
\end{tikzcd}\]

\begin{equation}\label{dgm:1}\begin{tikzcd}
  \hom_0(\cmp{\BB},\cmp{D})\arrow{d}{m} \arrow{r}{j} &
  \hom_0(\cmp{\bb}, \cmp{D}) \arrow{d}{\ell} \\
  %
  \hom_0(\cmp{\QQ^\of}, \cmp{P^\of}) \arrow{r}{i} &
  \hom_0(\cmp{\Q^\of}, \cmp{P^\of}).
\end{tikzcd}\end{equation}

\begin{theorem}[Geometric TCC]\label{thm:geo_tcc}
  Let $D$ be a compact subset of $\X$ and $f : D\to\R$ be $c$-Lipschitz function.
  Let $\omega\in\R$, $\of > 0$ be constants such that $\B$ surrounds $D$ in $\X$.
  Let $P\subset D$ be a finite collection of points and $Q_\alpha := P\cap B_\alpha$ for $\alpha\in\R$.
  Let $j : \hom_0(\cmp{\BB},\cmp{D})\to \hom_0(\cmp{\B},\cmp{D})$ and $i : \hom_0(\cmp{\QQ^\of}, \cmp{P^\of})\to \hom_0(\cmp{\Q^\of}, \cmp{P^\of})$ be induced by inclusion.

  If $j$ is surjective and $\rk~i\geq \rk~j$ then $D\setminus \B\subseteq P^\of$ and $\Q^\of$ surrounds $P^\of$ in $D$.
\end{theorem}
\begin{proof}
  Because $j$ is surjective by hypothesis $\rk~j = \dim~\hom_0(\cmp{\B},\cmp{D})$ so $\rk~j\geq \rk~i$ by Lemma~\ref{lem:psurj}.
  So $\rk~j = \rk~i$ with our assumption that $\rk~i\geq \rk~j$.
  Because $P$ is a finite point set we know that $\im~i$ is finite-dimensional and, because $\rk~i = \rk~j$, $\im~j=\hom_0(\cmp{\B}, \cmp{D})$ is finite dimensional as well.

  So $\im~j$ is isomorphic to $\im~i$ as a subspace of $\hom_0(\cmp{\Q^\of}, \cmp{P^\of})$ which, because $j$ is surjective, requires the map $\ell$ induced by inclusion to be injective.
  Therefore, $D\setminus\bb\subseteq P^\of$ by Lemma~\ref{lem:coverage}, and $\Q^\of$ surrounds $P^\of$ in $D$ by Lemma~\ref{lem:cov_surrounds}.
\end{proof}

A ball $\ball_D^\e(x)$ is said to be \textbf{strongly convex} if for each pair of points $y,z$ in the closure of $\ball_D^\e(x)$ there exists a unique shortest path in $D$ between $y$ and $z$, and the interior of this path is included in $\ball_D^\e(x)$.
Let $\varrho_D(x)$ be the supremum of the radii such that $\ball_D^\e(x)$ is strongly convex.
The \textbf{strong convexity radius} of $D$ is defined
\[ \varrho_D := \inf_{x\in D} \varrho_D(x).\]
Note that this value is positive for compact $D$.

\begin{theorem}[Algorithmic TCC]\label{thm:algo_tcc}
  Let $\X$ be an orientable $d$-manifold and let $D$ be a compact subset of $\X$ with strong convexity radius $\varrho_D > \delta$.
  Let $f : D\to\R$ be $c$-Lipschitz function and $B_w := f^{-1}((-\infty,w])$.
  Let $\omega\in\R$ and $\delta\leq\zeta < \varrho_D$ be constants such that
  \begin{enumerate}
    \item $B_{\omega - c(\zeta +\delta)}$ surrounds $D$ in $\X$,
    \item $\hom_0(D\setminus B_{\omega+c(\delta+\zeta)}\hookrightarrow D\setminus B_\omega)$ is surjective,
    \item $\hom_0(D\setminus B_\omega\hookrightarrow D\setminus B_{\omega+c(\delta+\zeta)})$ is injective.
  \end{enumerate}

  Let $P$ be a finite subset of $D$ such that $P^\delta\subset \intr_\X(D)$ and $D\setminus S^\delta$ is locally path connected for all $S\subseteq P$.
  Let $Q_w := Q\cap B_w$.

  If
  \[\rk~\hom_d(\rips^\delta(P, Q_{\omega -c\zeta})\hookrightarrow \rips^{2\delta}(P, Q_{\omega+c\delta})) \geq \dim~\hom_0(\rips^\delta(P\setminus Q_{\omega-c\zeta}))\]
  then $D\setminus B_\omega\subseteq P^\delta$ and $Q_{\omega-c\zeta}^\delta$ surrounds $P^\delta$ in $D$.
\end{theorem}
\begin{proof}
  Because $S^\delta$ is open in $D$ for any $S\subseteq P$, and $D$ is compact in $\X$, the complement $D\setminus S^\delta$ is closed in $D$, and therefore compact in $\X$.
  Moreover, because $P^\delta\subset \intr_\X(D)$, $\hom_d(\X\setminus(D\setminus P^\delta), \X\setminus(D\setminus S^\delta)) = \hom_d(P^\delta, S^\delta)$.
  As we have assumed these complements are locally path connected by assumption we have natural isomorphisms
  \[\xi_S : \hom_d(P^\delta, S^\delta)\to \hom_0(D\setminus S^\delta, D\setminus P^\delta)\]
  for all $S\subseteq P$ by Lemma~\ref{cor:alexander_iso}.

  Recall, the \v{C}ech complex $\cech^\delta(P, S)$ is the nerve of the pair of open covers by metric balls associated with a pair $(P, S)$ at scale $\delta$.
  As we have assumed $\delta\leq\varrho_D$ these covers are good, so we have isomorphisms $\N_S : \hom_d(\cech^\delta(P, S))\to \hom_d(P^\delta, Q^\delta)$ for all $S\subseteq P$ by the Nerve Theorem.
  Let
  \[ \xi\N_S := \xi_S\circ\N_S : \hom_d(\cech^\delta(P, S))\to \hom_0(D\setminus S^\delta, D\setminus P^\delta).\]

  The following square commutes by Lemma~\ref{lem:rel_pers_nerve}
  \[\begin{tikzcd}
    \hom_d(\cech^\delta(P, Q_{\omega-c\zeta})) \arrow{r}\arrow{d}{\N_{Q_{\omega-c\zeta}}} &
    \hom_d(\cech^\delta(P, Q_{\omega+c\delta})) \arrow{d}{\N_{Q_{\omega-c\zeta}}}\\
    %
    \hom_d(P^\delta, Q_{\omega-c\zeta}^\delta))\arrow{r} &
    \hom_d(P^\delta, Q_{\omega+c\delta}^\delta).
  \end{tikzcd}\]
  Therefore, by the naturality of $\xi_{S}$ the compositions $\xi\N_{Q_{\omega-c\zeta}}, \xi\N_{Q_{\omega+c\delta}}$ commute with inclusions.
  Letting
  \[ i : \hom_0(D\setminus Q_{\omega+c\delta}^\delta, D\setminus P^\delta)\to \hom_0(D\setminus Q_{\omega-c\zeta}^\delta, D\setminus P^\delta)\]
  as in Theorem~\ref{thm:geo_tcc} it follows that
  \[ \rk~i = \rk~\hom_d(\cech^\delta(P, Q_{\omega-c\zeta})\hookrightarrow \cech^\delta(P,Q_{\omega+c\delta})).\]
  % Thus,
  % \[\rk~\hom_0((D\setminus Q_{\omega+c\delta}^\delta, D\setminus P^\delta)\hookrightarrow (D\setminus Q_{\omega-c\zeta}^\delta, D\setminus P^\delta)) = \rk~\hom_d(\cech^\delta(P, Q_\omega-c\zeta)\hookrightarrow \cech^\delta(P,Q_{\omega+c\delta})).\]

  As $\rips^\delta(P, S)\subseteq \cech^\delta(P, S)\subseteq \rips^{2\delta}(P,S)$ for any $S\subseteq P$ we have the following sequence of homomorphisms induced by inclusion
  \[ \hom_d(\rips^\delta(P, Q_{\omega-c\zeta}))\to\hom_d(\cech^\delta(P, Q_{\omega-c\zeta}))\to\hom_d(\cech^\delta(P, Q_{\omega+c\delta})))\to\hom_d(\rips^{2\delta}(P, Q_{\omega+c\delta})).\]
  Now,
  \begin{align*}
    \rk~i &= \rk~\hom_d(\cech^\delta(P, Q_{\omega-c\zeta})\hookrightarrow \cech^\delta(P,Q_{\omega+c\delta}))\\
      &\geq \rk~\hom_d(\rips^{\delta}(P, Q_{\omega+c\delta}))\hookrightarrow \rips^{2\delta}(P, Q_{\omega+c\delta}))).
  \end{align*}

  Assume there exist $p,q \in P\setminus Q_{\omega-c\zeta}$ such that $p$ and $q$ are connected in $\rips^\delta(P\setminus Q_{\omega-c\zeta})$ but not in $D\setminus B_\omega$.
  So the shortest path from $p, q$ is a subset of $(P\setminus Q_{\omega-c\zeta})^\delta$.
  For any $x\in (P\setminus Q_{\omega-c\zeta})^\delta$ there exists some $p\in P$ such that $f(p) > \omega - c\zeta$ and $\dist(p,x) < \delta$.
  Because $f$ is $c$-Lipschitz
  \[ f(x)\geq f(p) - c\dist(x,p) > \omega - c(\delta+\zeta)\]
  so there is a path from $p$ to $q$ in $D\setminus B_{\omega-c(\delta+\zeta)}$, thus $[p] = [q]$ in $\hom_0(D\setminus B_{\omega-c(\delta+\zeta)})$.

  But we have assumed that $[p]\neq[q]$ in $\hom_0(D\setminus B_\omega)$, contradicting our assumption that $\hom_0(D\setminus B_\omega\hookrightarrow D\setminus B_{\omega-c(\delta+\zeta)})$ is injective, so any $p,q$ connected in $\rips^\delta(P\setminus Q_{\omega-c\zeta})$ are connected in $D\setminus B_\omega$.
  That is, $\dim~\hom_0(\rips^\delta(P\setminus Q_{omega-c\zeta}))\geq \dim~\hom_0(D\setminus B_\omega)$.

  Putting it all together,
  \[ \rk~\hom_d(\rips^\delta(P, Q_{\omega -c\zeta})\hookrightarrow \rips^{2\delta}(P, Q_{\omega+c\delta})) \geq \dim~\hom_0(\rips^\delta(P\setminus Q_{\omega-c\zeta}))\]
  implies $\rk~i\geq\dim~\hom_0(D\setminus B_\omega)$ as
  \begin{align*}
    \rk~i &\geq \rk~\hom_d(\rips^\delta(P, Q_{\omega -c\zeta})\hookrightarrow \rips^{2\delta}(P, Q_{\omega+c\delta}))\\
      &\geq \dim~\hom_0(\rips^\delta(P\setminus Q_{\omega-c\zeta}))\\
      &\geq \dim~\hom_0(D\setminus B_\omega).
  \end{align*}
  So $D\setminus B_\omega\subseteq P^\delta$ and $Q_{\omega-c\zeta}^\delta$ surrounds $P^\delta$ in $D$ by Theorem~\ref{thm:geo_tcc}.

\end{proof}
